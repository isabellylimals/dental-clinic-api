<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: Paciente & Prontu√°rio</title>
    <style>
        :root { --primary: #8e44ad; --secondary: #9b59b6; --success: #27ae60; --dark: #2c3e50; --light: #ecf0f1; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--light); color: var(--dark); padding: 20px; max-width: 1000px; margin: 0 auto; }
        
        h1 { text-align: center; color: var(--primary); border-bottom: 3px solid #ddd; padding-bottom: 10px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full { grid-column: 1 / -1; }

        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 5px solid var(--primary); }
        
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #bdc3c7; border-radius: 4px; box-sizing: border-box; }
        
        button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-add { background-color: var(--primary); } .btn-add:hover { background-color: var(--secondary); }
        .btn-view { background-color: var(--success); padding: 5px 10px; width: auto; margin: 0; font-size: 0.8em; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background-color: #f9f9f9; }

        .prontuario-box { background: #2c3e50; color: #2ecc71; padding: 15px; border-radius: 5px; margin-top: 20px; font-family: monospace; display: none; }
    </style>
</head>
<body>

    <h1>üè• Fluxo: Paciente -> Prontu√°rio</h1>

    <div class="grid">
        
        <div class="card">
            <h2>1. Novo Paciente</h2>
            <small>Ao cadastrar, o Prontu√°rio deve ser criado automaticamente no backend.</small>
            
            <label>Nome Completo:</label>
            <input type="text" id="nome" placeholder="Ex: Ana Silva">
            
            <label>Email:</label>
            <input type="email" id="email" placeholder="Ex: ana@email.com">
            
            <label>CPF (Obrigat√≥rio):</label>
            <input type="text" id="cpf" placeholder="12345678900">
            
            <label>Senha:</label>
            <input type="password" id="senha" value="123456">
            
            <label>Telefone:</label>
            <input type="text" id="telefone" placeholder="84 99999-8888">

            <button class="btn-add" onclick="cadastrarPaciente()">Cadastrar Paciente</button>
            <p id="msgCadastro" style="text-align: center; margin-top: 10px; font-weight: bold;"></p>
        </div>

        <div class="card">
            <h2>2. Pacientes Cadastrados</h2>
            <button onclick="listarPacientes()" style="background-color: #34495e; margin-top: 0; margin-bottom: 10px;">üîÑ Atualizar Lista</button>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="tabelaPacientes">
                    <tr><td colspan="4">Carregando...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card full">
            <h2>3. Visualizar Prontu√°rio</h2>
            <p>Clique no bot√£o "Ver Prontu√°rio" na lista acima para buscar os dados.</p>
            
            <div id="prontuarioArea" class="prontuario-box">
                <h3>üìÑ Ficha do Prontu√°rio</h3>
                <p><b>ID Prontu√°rio:</b> <span id="pId"></span></p>
                <p><b>Paciente:</b> <span id="pNome"></span> (ID: <span id="pIdPac"></span>)</p>
                <p><b>Data de Cria√ß√£o:</b> <span id="pData"></span></p>
                <p><b>Tem Anamnese?</b> <span id="pAnamnese"></span></p>
                <hr style="border-color: #555;">
                <p><i>JSON Bruto:</i></p>
                <pre id="pJson"></pre>
            </div>
        </div>

    </div>

    <script>
        const BASE_URL = "http://localhost:8080/api";

        // 1. CADASTRAR
        async function cadastrarPaciente() {
            const msg = document.getElementById('msgCadastro');
            msg.textContent = "Enviando...";
            msg.style.color = "blue";

            const paciente = {
                tipoUsuario: "PACIENTE", // FUNDAMENTAL PARA O JSON TYPE INFO
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                senha: document.getElementById('senha').value,
                telefone: document.getElementById('telefone').value,
                cpf: document.getElementById('cpf').value
            };

            try {
                const res = await fetch(`${BASE_URL}/usuarios/cadastro`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paciente)
                });

                if(res.ok) {
                    msg.textContent = "Sucesso! Paciente e Prontu√°rio criados.";
                    msg.style.color = "green";
                    listarPacientes(); // Atualiza a lista
                } else {
                    const erro = await res.text();
                    msg.textContent = "Erro: " + erro;
                    msg.style.color = "red";
                }
            } catch (e) {
                msg.textContent = "Erro de conex√£o.";
                msg.style.color = "red";
            }
        }

        // 2. LISTAR (Filtra apenas PACIENTE)
        async function listarPacientes() {
            const tbody = document.getElementById('tabelaPacientes');
            tbody.innerHTML = "<tr><td colspan='4'>Buscando...</td></tr>";

            try {
                const res = await fetch(`${BASE_URL}/usuarios`);
                const lista = await res.json();
                
                tbody.innerHTML = "";
                
                // Filtra no JS quem √© PACIENTE
                const pacientes = lista.filter(u => u.tipoUsuario === 'PACIENTE');

                if(pacientes.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='4'>Nenhum paciente encontrado.</td></tr>";
                    return;
                }

                pacientes.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${p.idUsuario}</td>
                        <td>${p.nome}</td>
                        <td>${p.cpf || '-'}</td>
                        <td><button class="btn-view" onclick="buscarProntuario(${p.idUsuario})">Ver Prontu√°rio</button></td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                tbody.innerHTML = "<tr><td colspan='4' style='color:red'>Erro ao listar.</td></tr>";
            }
        }

        // 3. BUSCAR PRONTU√ÅRIO
        async function buscarProntuario(idPaciente) {
            const area = document.getElementById('prontuarioArea');
            area.style.display = 'block';
            area.innerHTML = "Buscando prontu√°rio no banco de dados...";

            try {
                // Chama o endpoint do ProntuarioController
                const res = await fetch(`${BASE_URL}/prontuarios/paciente/${idPaciente}`);
                
                if(res.ok) {
                    const data = await res.json();
                    
                    // Renderiza os dados bonitinhos
                    document.getElementById('prontuarioArea').innerHTML = `
                        <h3>üìÑ Ficha do Prontu√°rio Encontrada!</h3>
                        <p><b>ID Prontu√°rio:</b> ${data.idProntuario}</p>
                        <p><b>Paciente:</b> ${data.paciente.nome} (ID: ${data.paciente.idUsuario})</p>
                        <p><b>Data de Abertura:</b> ${data.dataCriacao}</p>
                        <p><b>Status Anamnese:</b> ${data.anamnese ? "‚úÖ Preenchida" : "‚ùå Pendente"}</p>
                        <hr style="border-color: #555;">
                        <p><i>Dados Brutos:</i></p>
                        <pre>${JSON.stringify(data, null, 4)}</pre>
                    `;
                } else {
                    area.innerHTML = `<h3 style='color:#e74c3c'>Erro: Prontu√°rio n√£o encontrado!</h3>
                    <p>Isso significa que o 'UsuarioService' n√£o criou o prontu√°rio automaticamente ou ocorreu um erro na busca.</p>`;
                }
            } catch (e) {
                area.textContent = "Erro de conex√£o ao buscar prontu√°rio.";
            }
        }

        // Carrega a lista ao abrir
        listarPacientes();
    </script>

</body>
</html>