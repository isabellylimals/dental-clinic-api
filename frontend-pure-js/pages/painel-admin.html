<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Gest√£o</title>
    <style>
        :root { --primary: #007bff; --dark: #343a40; --bg: #f4f7f6; }
        
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 0; }

        /* --- CABE√áALHO (NAVBAR) --- */
        header {
            background-color: var(--dark);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        header h1 { margin: 0; font-size: 20px; }
        .user-info { font-size: 14px; margin-right: 15px; }
        .btn-sair {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-sair:hover { background-color: #c82333; }

        /* --- CONTE√öDO --- */
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }

        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h3 { margin-top: 0; color: #333; border-bottom: 2px solid var(--primary); padding-bottom: 10px; display: inline-block; }

        /* FORMUL√ÅRIO */
        .row { display: flex; gap: 15px; margin-bottom: 10px; }
        .col { flex: 1; }
        
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 14px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

        .hidden { display: none; }
        .area-especifica { background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-top: 10px; border-left: 4px solid var(--primary); }

        button.btn-cadastrar {
            width: 100%; padding: 12px; background-color: #28a745; color: white; 
            border: none; border-radius: 5px; margin-top: 15px; cursor: pointer; font-weight: bold; font-size: 16px;
        }
        button.btn-cadastrar:hover { background-color: #218838; }

        /* TABELA */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: var(--primary); color: white; }
        tr:hover { background-color: #f1f1f1; }

        .badge { padding: 4px 8px; border-radius: 12px; color: white; font-size: 11px; font-weight: bold; }
        .bg-medico { background-color: #17a2b8; }
        .bg-paciente { background-color: #ffc107; color: black; }
        .bg-admin { background-color: #343a40; }
    </style>
</head>
<body>

    <header>
        <h1>üõ†Ô∏è Painel Administrativo</h1>
        <div>
            <span id="adminNome" class="user-info">Ol√°, Admin</span>
            <button class="btn-sair" onclick="sair()">Sair üö™</button>
        </div>
    </header>

    <div class="container">

        <div class="card">
            <h3>Cadastrar Novo Usu√°rio</h3>
            
            <label>Tipo de Usu√°rio:</label>
            <select id="tipoUsuario" onchange="mudarFormulario()">
                <option value="PACIENTE">Paciente</option>
                <option value="MEDICO">M√©dico</option>
                <option value="ADMINISTRADOR">Administrador</option>
            </select>

            <div class="row">
                <div class="col">
                    <label>Nome:</label>
                    <input type="text" id="nome" placeholder="Nome Completo">
                </div>
                <div class="col">
                    <label>Telefone:</label>
                    <input type="text" id="telefone" placeholder="(XX) XXXXX-XXXX">
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Email:</label>
                    <input type="email" id="email" placeholder="email@exemplo.com">
                </div>
                <div class="col">
                    <label>Senha:</label>
                    <input type="password" id="senha" placeholder="******">
                </div>
            </div>

            <div id="camposMedico" class="area-especifica hidden">
                <div class="row">
                    <div class="col">
                        <label>CRM:</label>
                        <input type="text" id="crm" placeholder="CRM/UF 12345">
                    </div>
                    <div class="col">
                        <label>Especialidade:</label>
                        <input type="text" id="especialidade" placeholder="Ex: Cardiologista">
                    </div>
                </div>
            </div>

            <div id="camposPaciente" class="area-especifica">
                <div class="row">
                    <div class="col">
                        <label>CPF:</label>
                        <input type="text" id="cpf" placeholder="000.000.000-00">
                    </div>
                    <div class="col">
                        <label>Data Nascimento:</label>
                        <input type="date" id="dataNascimento">
                    </div>
                </div>
                <label>Endere√ßo:</label>
                <input type="text" id="endereco" placeholder="Endere√ßo completo">
            </div>

            <button class="btn-cadastrar" onclick="cadastrar()">Salvar Usu√°rio</button>
            <p id="mensagem" style="text-align: center; margin-top: 10px; font-weight: bold;"></p>
        </div>

        <div class="card">
            <h3>Usu√°rios do Sistema</h3>
            <button onclick="carregarUsuarios()" style="background: #6c757d; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; float: right;">üîÑ Atualizar</button>
            <div style="clear: both;"></div>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tipo</th>
                        <th>Nome / Email</th>
                        <th>Detalhes</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="tabelaCorpo"></tbody>
            </table>
        </div>

    </div>

    <script>
        const API_URL = "http://localhost:8080/api/usuarios";

        // 1. SEGURAN√áA: Verifica se √© ADMIN ao carregar a p√°gina
        window.onload = function() {
            const usuarioStr = localStorage.getItem("usuarioLogado");
            if (!usuarioStr) {
                alert("Acesso negado! Fa√ßa login.");
                // window.location.href = "login.html"; // Comentado para teste, descomente depois
                // return;
            }

            // Mock para teste (se n√£o tiver login real)
            const usuario = usuarioStr ? JSON.parse(usuarioStr) : { nome: "Admin Teste", tipoUsuario: "ADMINISTRADOR" };
            
            if (usuario.tipoUsuario !== "ADMINISTRADOR") {
                alert("Voc√™ n√£o tem permiss√£o para acessar esta p√°gina!");
                // window.location.href = "perfil.html";
                // return;
            }

            document.getElementById("adminNome").innerText = "Ol√°, " + usuario.nome;
            carregarUsuarios(); // Carrega a lista se for admin
        };

        // 2. FUN√á√ÉO SAIR (LOGOUT)
        function sair() {
            localStorage.removeItem("usuarioLogado");
            window.location.href = "login.html";
        }

        // 3. INTERFACE DIN√ÇMICA (Campos M√©dico/Paciente)
        function mudarFormulario() {
            const tipo = document.getElementById("tipoUsuario").value;
            const divMedico = document.getElementById("camposMedico");
            const divPaciente = document.getElementById("camposPaciente");

            divMedico.classList.add("hidden");
            divPaciente.classList.add("hidden");

            if (tipo === "MEDICO") divMedico.classList.remove("hidden");
            else if (tipo === "PACIENTE") divPaciente.classList.remove("hidden");
        }

        // 4. CADASTRAR
        async function cadastrar() {
            const tipo = document.getElementById("tipoUsuario").value;
            const msg = document.getElementById("mensagem");

            let dados = {
                tipoUsuario: tipo,
                nome: document.getElementById("nome").value,
                email: document.getElementById("email").value,
                senha: document.getElementById("senha").value,
                telefone: document.getElementById("telefone").value
            };

            if (tipo === "MEDICO") {
                dados.crm = document.getElementById("crm").value;
                dados.especialidade = document.getElementById("especialidade").value;
            } else if (tipo === "PACIENTE") {
                dados.cpf = document.getElementById("cpf").value;
                dados.dataNascimento = document.getElementById("dataNascimento").value;
                dados.endereco = document.getElementById("endereco").value;
            }

            try {
                const res = await fetch(API_URL + "/cadastro", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(dados)
                });

                if (res.status === 201 || res.status === 200) {
                    msg.innerText = "‚úÖ Cadastrado com sucesso!";
                    msg.style.color = "green";
                    carregarUsuarios();
                } else {
                    const erro = await res.text();
                    msg.innerText = "‚ùå Erro: " + erro;
                    msg.style.color = "red";
                }
            } catch (e) {
                console.error(e);
                alert("Erro de conex√£o!");
            }
        }

        // 5. LISTAR (CORRIGIDO: USA 'STATS' EM VEZ DE 'STATUS')
        async function carregarUsuarios() {
            try {
                const res = await fetch(API_URL);
                const lista = await res.json();
                const tbody = document.getElementById("tabelaCorpo");
                tbody.innerHTML = "";

                lista.forEach(u => {
                    // Badge de Tipo
                    let badge = "";
                    let extra = "";
                    
                    if (u.tipoUsuario === "MEDICO") {
                        badge = '<span class="badge bg-medico">M√âDICO</span>';
                        extra = `CRM: ${u.crm || '-'}`;
                    } else if (u.tipoUsuario === "PACIENTE") {
                        badge = '<span class="badge bg-paciente">PACIENTE</span>';
                        extra = `CPF: ${u.cpf || '-'}`;
                    } else {
                        badge = '<span class="badge bg-admin">ADMIN</span>';
                        extra = "-";
                    }

                    // --- AQUI ESTAVA O ERRO DO JAVASCRIPT ---
                    // O Java manda 'stats', mas o c√≥digo buscava 'status'
                    let statusAtivo = u.stats; // <--- CORRE√á√ÉO PRINCIPAL

                    let statusIcon = statusAtivo ? "üü¢" : "üî¥";
                    let linhaStyle = statusAtivo ? "" : "background-color: #ffe6e6; color: #999;"; 
                    
                    let botaoAcao = "";
                    if (statusAtivo) {
                        botaoAcao = `<button onclick="alterarStatus(${u.idUsuario}, false)" style="background: #dc3545; color: white; border:none; padding: 5px 10px; border-radius:4px; cursor:pointer;">üóëÔ∏è Desativar</button>`;
                    } else {
                        botaoAcao = `<button onclick="alterarStatus(${u.idUsuario}, true)" style="background: #28a745; color: white; border:none; padding: 5px 10px; border-radius:4px; cursor:pointer;">‚úÖ Reativar</button>`;
                    }

                    const tr = `
                        <tr style="${linhaStyle}">
                            <td>${u.idUsuario}</td>
                            <td>${statusIcon} ${badge}</td>
                            <td>
                                <strong>${u.nome}</strong><br>
                                <small>${u.email}</small>
                            </td>
                            <td>${extra}</td>
                            <td>${botaoAcao}</td>
                        </tr>
                    `;
                    tbody.innerHTML += tr;
                });
            } catch (e) {
                console.error(e);
            }
        }
        
        // 6. ALTERAR STATUS
        async function alterarStatus(id, novoStatus) {
            if (novoStatus === false) {
                if(!confirm("Tem certeza que deseja desativar este usu√°rio?")) return;
                await fetch(`${API_URL}/${id}`, { method: "DELETE" });
            } else {
                if(!confirm("Deseja reativar este usu√°rio?")) return;
                await fetch(`${API_URL}/${id}/ativar`, { method: "PUT" });
            }
            carregarUsuarios();
        }

    </script>
</body>
</html>